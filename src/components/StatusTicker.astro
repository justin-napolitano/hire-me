---
import { buildTickerPayload } from '../lib/status';
import type { StatusTickerConfig } from '../config/profile';

type Props = {
	config?: StatusTickerConfig;
	apiEndpoint?: string;
};

const { config, apiEndpoint = '/api/statuses.json' } = Astro.props as Props;

const payload = buildTickerPayload(config);
const initialLine = payload.override ?? payload.statuses[0]?.text ?? 'Setting the vibe...';
const statusesAttr = JSON.stringify(payload.statuses);
---
<div
	class="rounded-2xl border border-[var(--border-strong)] bg-[var(--surface-section)] px-5 py-4"
	data-ticker
	data-statuses={statusesAttr}
	data-interval={payload.intervalMs}
	data-override={payload.override ?? ''}
	data-endpoint={apiEndpoint}
>
	<div class="flex items-center gap-2 text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-[var(--text-label)]">
		<span class="h-2 w-2 animate-pulse rounded-full bg-[var(--accent)]"></span>
		<span>Operating cadence</span>
	</div>
	<p class="mt-2 text-lg text-[var(--text-secondary)]" data-ticker-text>{initialLine}</p>
</div>

<script>
	(() => {
		const container = document.currentScript?.previousElementSibling;
		if (!(container instanceof HTMLElement)) return;

		const textEl = container.querySelector('[data-ticker-text]');
		if (!(textEl instanceof HTMLElement)) return;

		const parseLines = (raw) => {
			if (!raw) return [];
			try {
				const parsed = JSON.parse(raw);
				return Array.isArray(parsed) ? parsed.map((entry) => entry.text).filter(Boolean) : [];
			} catch (error) {
				console.warn('Ticker parse failed', error);
				return [];
			}
		};

		const dataset = container.dataset;
		let lines = dataset.override ? [dataset.override] : parseLines(dataset.statuses);
		let interval = Number(dataset.interval ?? 6500) || 6500;
		let index = 0;

		const swapLine = () => {
			if (!lines.length) return;
			textEl.classList.add('opacity-0', 'translate-y-1', 'duration-300', 'transition');
			window.setTimeout(() => {
				textEl.textContent = lines[index % lines.length];
				textEl.classList.remove('translate-y-1');
				textEl.classList.add('translate-y-0');
				textEl.classList.remove('opacity-0');
			}, 150);
		};

		const rotate = () => {
			if (lines.length <= 1) return;
			index = (index + 1) % lines.length;
			swapLine();
		};

		const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
		let timer;

		const restart = () => {
			if (timer) {
				window.clearInterval(timer);
			}
			if (motionQuery.matches || lines.length <= 1) return;
			timer = window.setInterval(rotate, interval);
		};

		restart();
		motionQuery.addEventListener('change', restart);

		const endpoint = dataset.endpoint || '/api/statuses.json';

		const hydrateFromAPI = async () => {
			try {
				const response = await fetch(endpoint);
				if (!response.ok) return;
				const payload = await response.json();
				const incoming = payload.override
					? [payload.override]
					: (payload.statuses ?? []).map((entry) => entry.text).filter(Boolean);
				if (!incoming.length) return;
				lines = incoming;
				interval = Number(payload.intervalMs) || interval;
				index = 0;
				swapLine();
				restart();
			} catch (error) {
				console.warn('Status ticker fetch failed', error);
			}
		};

		hydrateFromAPI();
		window.setInterval(hydrateFromAPI, 120000);
	})();
</script>
